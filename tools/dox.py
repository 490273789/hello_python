from docx import Document
from docx.shared import Pt
from docx.oxml.ns import qn
from docx.enum.text import WD_ALIGN_PARAGRAPH

doc = Document()


def add_heading(text, level=1):
    doc.add_heading(text, level=level)


def add_para(text):
    p = doc.add_paragraph(text)
    p.paragraph_format.space_after = Pt(6)


def add_table(rows, cols, data, col_width=None):
    table = doc.add_table(rows=rows, cols=cols)
    table.style = "Table Grid"
    for r in range(rows):
        row_cells = table.rows[r].cells
        for c in range(cols):
            row_cells[c].text = data[r][c]
    return table


add_heading("第二章 网格通APP端侧触点方案", 1)

add_heading("方案一：网格通APP智能推荐改造", 2)
add_para(
    "目标：在现有查询画像+推荐产品功能基础上，引入AI推荐并闭环反馈，提升推荐转化率与一线执行效率。"
)
data1 = [
    ["维度", "内容"],
    ["使用场景", "外呼、随销、异网赢回，手机号→画像→推荐→反馈"],
    ["核心模块", "实时推荐服务、推荐结果对比、话术生成、反馈归因、埋点回流"],
    ["技术路径", "复用原画像接口+新增推荐API+Redis缓存+Kafka回流+Flink清洗+模型训练"],
    ["成本估算", "约4.5人月（后端、算法、数据、产品）"],
    ["指标提升", "转化率8%→12%，人均办理数提升15%，增收约7万元/月（单省）"],
    ["风险缓释", "推荐理由展示、反馈简化、冷启动用规则+协同过滤"],
    ["复制策略", "统一接口规范+产品池配置可移植"],
]
add_table(len(data1), 2, data1)

add_heading("方案二：接入集团灵犀助手", 2)
data2 = [
    ["维度", "内容"],
    ["使用场景", "语音意图+多轮问答+实时推荐+外呼转写"],
    ["核心模块", "意图识别、语音转写、画像摘要、二次推荐、语音反馈"],
    ["技术路径", "灵犀WebSocket接入+本地推荐API+NLP关键词抽取+缓存复用"],
    ["成本估算", "约2人月（接口封装+算法适配）"],
    ["指标提升", "转化率8%→13%，响应时长缩短60%，增收约8.75万元/月（单省）"],
    ["风险缓释", "集团接口未开放→降级语音转写；识别错→置信度回退"],
    ["复制策略", "多省已有灵犀，减少二次开发"],
]
add_table(len(data2), 2, data2)

add_heading("方案三：自建独立营销助手", 2)
data3 = [
    ["维度", "内容"],
    ["使用场景", "对话式营销（宽带提速、终端捆绑、套餐升档、异议处理、无手机号需求）"],
    [
        "核心模块",
        "对话管理、画像摘要、场景推荐、需求槽位抽取、知识库检索、话术生成、二次推荐",
    ],
    ["技术路径", "嵌入WebView/Flutter组件+双塔召回+排序模型+LLM话术+向量检索"],
    ["成本估算", "约12人月（前后端+算法+知识库+产品）"],
    ["指标提升", "转化率8%→14%，增收全国年化约1,512万元（假设12省）"],
    ["风险缓释", "分阶段迭代、标杆试点+合规审核+敏感词过滤"],
    ["复制策略", "统一组件包、集中模型服务、多省即插即用"],
]
add_table(len(data3), 2, data3)

add_heading("三方案对比矩阵", 2)
compare = [
    ["指标", "方案一", "方案二", "方案三"],
    ["启动周期", "6-8周", "4-6周(依赖)", "8-12周"],
    ["推荐精度潜力", "中", "中等", "高"],
    ["复用性", "中", "高", "高（自控）"],
    ["外部依赖", "低", "高", "低"],
    ["建设成本(人月)", "4.5", "2", "12"],
    ["首月单省增收(万元)", "7", "8.75", "10.5(全国扩散更高)"],
    ["风险重点", "反馈质量", "集团对接", "初始成本"],
    ["战略价值", "强化执行", "借力生态", "形成平台资产"],
]
add_table(len(compare), 4, compare)

add_heading("端侧通用闭环流程 (ASCII)", 2)
flow_ascii = """
[工单/客户进入]
      |
      v
[拉取客户画像] --> [AI推荐服务] --> [推荐结果+话术展示]
      |                                   |
      |                                   v
      |                              [网格经理触达]
      |                                   |
      v                                   v
[人工/AI结果对比]                  [办理/拒绝/延后]
      |                                   |
      v                                   v
[反馈原因采集]  <---------------- [结果提交]
      |
      v
[Kafka埋点] -> [Flink清洗] -> [特征仓] -> [模型再训练] -> [策略&权重调优]
"""
add_para(flow_ascii)

add_heading("第三章 后台推荐系统方案", 1)

add_heading("方案一：嵌入IOP系统", 2)
iop = [
    ["维度", "内容"],
    ["定位", "深度治理+批量预推+多目标排序+全域工单触点"],
    ["数据层", "CRM/计费/行为/酬金→清洗→标签运营中心→特征仓"],
    ["模型层", "召回(规则+协同+Embedding)+排序(Wide&Deep/GBT)+话术生成(LLM+模板)"],
    ["运营层", "产品池、酬金权重、场景开关、A/B试验、黑白名单"],
    ["服务层", "批量调度(Flink) + 实时推理(gRPC) + 缓存(Redis)"],
    ["闭环", "推荐→执行→反馈→评估→再训练→权重更新"],
    ["价值", "转化率8%→13%，无效工单占比40%→25%"],
    ["成本", "约20人月；周期10-12周"],
    ["风险缓释", "数据质量评分、推荐解释、酬金权重版本管理"],
]
add_table(len(iop), 2, iop)

add_heading("方案二：跳过IOP轻量实时推荐", 2)
lite = [
    ["维度", "内容"],
    ["定位", "快速上线验证，直接用现有标签画像实时推荐"],
    ["数据输入", "结构化标签（套餐、带宽、终端、融合、ARPU）"],
    ["模型", "规则+LightGBM 排序，失败回退静态规则"],
    ["产品池", "省级Excel上传+基础校验"],
    ["服务", "单一实时API+简单缓存"],
    ["闭环", "推荐→触达→反馈→轻量特征补充（后期扩展）"],
    ["价值", "转化率8%→10%，增收约3.5万元/月（单省）"],
    ["成本", "约2人月；周期3-4周"],
    ["风险缓释", "行为补充特征、产品池更新提醒"],
    ["升级路径", "轻量→引入行为→接入更多数据→迁移至IOP版"],
]
add_table(len(lite), 2, lite)

add_heading("推荐流程通用ASCII架构", 2)
arch = """
[原始数据] -> [清洗/校验] -> [标签运营] -> [特征仓(静态+行为+酬金)]
       |                                   |
       | (批量)                            | (实时)
       v                                   v
[批量预推任务]                        [实时召回+排序]
       |                                   |
       v                                   v
[推荐快照缓存]                      [TopN推荐+话术]
       |                                   |
       +-------------> [下发工单/网格通展示] <-----------+
                                          |
                                          v
                                   [结果反馈埋点]
                                          |
                                          v
                                   [Flink清洗回流]
                                          |
                                          v
                                  [特征更新/再训练]
"""
add_para(arch)

add_heading("核心指标体系", 2)
kpi = [
    ["指标类别", "指标", "公式/说明", "目标样例"],
    ["过程", "推荐调用成功率", "成功响应/总调用", "≥99%"],
    ["过程", "推荐延时P95", "接口响应时延", "≤800ms"],
    ["效果", "推荐转化率", "成功办理/推荐触达", "≥12%(IOP) / ≥10%(轻量)"],
    ["效果", "推荐采纳率", "采纳推荐产品办理数/推荐工单", "≥35%"],
    ["模型", "Top1精确率", "Top1产品命中真实意向", "≥30%"],
    ["模型", "多样性", "不同品类覆盖/总推荐", "≥0.6"],
    ["收益", "增收", "办理数*单均增收", "同比+30%"],
    ["收益", "人效提升率", "(上线后人均办理-基线)/基线", "≥15%"],
    ["反馈", "反馈填写率", "有反馈工单/推荐失败工单", "≥85%"],
]
add_table(len(kpi), 4, kpi)

add_heading("价值量化公式", 2)
add_para("推荐转化率 = 成功办理数 / 推荐触达数")
add_para("增收 = 成功办理数 * 单均增收")
add_para("ROI = (增收 - 成本) / 成本")
add_para("人效提升率 = (上线后人均办理数 - 基线人均办理数)/基线人均办理数")
add_para("综合推荐评分 = α*匹配度 + β*酬金收益 + γ*利润率 + δ*留存价值")

add_heading("A/B实验设计要点", 2)
ab = [
    ["维度", "内容"],
    ["分流", "按网格或客户随机分层，保持样本独立性"],
    ["实验组", "AI排序TopN+话术；对照组：人工策略顺序"],
    ["周期", "7天快测 + 30天验证长期价值"],
    ["显著性", "p<0.05；最小提升门槛≥3pct"],
    ["扩展条件", "采纳率≥20%，拒绝原因中“无需求”占比下降≥5pct"],
]
add_table(len(ab), 2, ab)

add_heading("实施路线建议", 2)
road = [
    ["阶段", "时间", "动作", "产出"],
    ["阶段1", "0-1月", "轻量实时推荐+端侧改造(MVP)", "可用查询+反馈埋点"],
    ["阶段2", "2-3月", "批量预推+推荐理由+A/B", "提升转化&分析报表"],
    ["阶段3", "3-5月", "IOP嵌入+酬金融合+多模型", "高精度+收益最优化"],
    ["阶段4", "5-6月", "自建助手宽带场景上线", "对话式推荐试点"],
    ["阶段5", "6-9月", "助手多场景扩展+知识库+全渠道", "全国推广"],
]
add_table(len(road), 4, road)

doc.save("网格通介绍.docx")
print("文档已生成：网格通介绍.docx")
